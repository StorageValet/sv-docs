# Storage Valet — Implementation Plan (FINAL v3.1 • 2025‑10‑10)

**Purpose**  
Clean, current, and contradiction‑free version of the implementation plan ready for: (1) Claude Code kickoff, (2) ChatGPT project libraries, and (3) the pre‑repo package.

**Status**  
- **Authoritative pricing:** **Single tier at $299/month.** Other tiers are deprecated.  
- **Setup fee:** configurable; **disabled by default** pending confirmation.  
- **Marketing site:** **Webflow** (public marketing only).  
- **Portal:** Vite + React + TS (strict 12 files / 6 deps / <500 LOC).  
- **Backend:** Supabase (Postgres + Auth + Storage + Edge Functions).  
- **Billing:** Stripe Checkout + Customer Portal; webhooks in Supabase Edge Functions.  
- **Admin/Internal:** Retool for QR printing & ops dashboard (fallback staff page in portal only if Retool validation fails).

---

## 0) What changed vs prior “FINAL” draft (v3.0 → v3.1)
- **Removed multi‑tier Stripe prices (199/399).** Environment mapping now exposes only `premium299`. Setup fee is governed by `config_pricing.setup_fee_enabled` and `setup_fee_amount`. (Deprecates prior tier references while keeping env‑driven flexibility if needed later.)  
- **Replaced all “Softr” mentions with “Webflow”** for the marketing site, CTAs, and success redirects.  
- **Clarified Phase 0.6** gates and deliverables; tightened idempotency, signed‑URL photo policy, and deliverability matrix language.  
- **Aligned copy** to single‑tier messaging and “as needed” phrasing; removed customer‑facing cubic‑foot messaging (internal only).

These edits harmonize with your most recent architecture summaries and checklists while preserving the validated structure from the earlier plan.  

---

## 1) Executive summary (unchanged in spirit, corrected for pricing/site)
Across previous attempts, we standardized on a **lean, secure** architecture: Webflow (marketing) → Stripe Checkout → Supabase (Auth/DB/Storage) → React Portal (4 routes) with strict limits: **12 files, 6 deps, <500 LOC**. Use **Retool** for internal tooling (QR printing, ops), not a custom admin. RLS is the security linchpin.  

**Definition of Done (MVP):** A new customer can (a) pay via Stripe Checkout, (b) receive a magic link, (c) log in to `/dashboard`, (d) add items (photos via **signed URLs**), (e) schedule pickup/delivery, and (f) manage billing via Stripe Customer Portal—**with RLS verified for zero cross‑tenant access**.

---

## 2) System architecture (final)
- **Webflow (marketing only):** CTA hits an **Edge Function** (`create-checkout`) that creates a Stripe Checkout Session with `price_id=premium299`. Referral/promo codes pass via metadata.  
- **Stripe:** Hosted **Checkout** creates the subscription; hosted **Customer Portal** handles self‑serve billing. No card forms in our UI.  
- **Supabase:**  
  - **Auth:** Magic links only.  
  - **DB (sv.*):** `customer_profile`, `items`, `actions`, `webhook_events`, plus **config tables** for pricing/schedule/media limits.  
  - **Storage:** Private `item-photos` bucket; all renders via **time‑boxed signed URLs**.  
  - **Edge Functions:** `create-checkout`, `create-portal-session`, `stripe-webhook` (signature verify + idempotency + profile upsert + magic link).  
- **Portal (Vite + React + TS):** Routes = `/login`, `/dashboard`, `/schedule`, `/account` (optional `/staff/print` only if Retool fails).  
- **Internal tooling:** **Retool** is primary for staff QR printing and webhook event viewing.

---

## 3) Pricing & billing (single‑tier enforcement)
- **Plan:** `premium299` only.  
- **Setup fee:** `config_pricing.setup_fee_enabled=false` by default; `setup_fee_amount` retained for future enablement or promos.  
- **Env vars (production):**
  ```
  VITE_STRIPE_PRICE_TIER_2=price_live_premium299     # the ONLY active price exposed to frontend
  # optional: keep TIER_1/TIER_3 unset in prod; retain in staging only for safe experiments
  ```
- **Customer Portal:** link generated by `create-portal-session` Edge Function (never hardcode static billing URLs).

---

## 4) Phase 0.6 — must pass before portal build
1. **Stripe Customer Portal session function** (`create-portal-session`) callable from `/account`.  
2. **Signed‑URL photo policy** + Storage RLS: customers only access their own `item-photos/*` paths; renders via signed URL (1h).  
3. **Checkout function** (`create-checkout`) with referral/promo metadata; **no secrets** on Webflow.  
4. **Webhook idempotency:** unique on `webhook_events.event_id`; log‑first, short‑circuit duplicates; resilient upsert of `customer_profile`.  
5. **Email deliverability path:** use Supabase built‑in for MVP; template tested (<120s receipt) across Gmail/Outlook/iCloud/Yahoo/Proton.  
6. **Photo validation:** size/type guardrails (e.g., ≤5MB; JPG/PNG/WebP), reject HEIC by default.

**Exit gate:** all six operational, observable, and verified with a lightweight validation report (screenshots + short notes).

---

## 5) Validation sandbox (Replit) — the 6 tests
- **Auth magic link** round‑trip under 60–120s.  
- **RLS isolation**: A sees only A; B cannot read or mutate A by ID.  
- **CRUD + triggers**: `cubic_feet` generated; capacity rollups update; QR code generated.  
- **QR code sequence**: `SV-YYYY-######` increments globally.  
- **Photo upload & render**: owner‑only with signed URLs; cross‑tenant blocked.  
- **Webhook dry‑run**: event logged once; idempotency verified.  

**Outcome:** write **Replit_Validation_Report_YYYY‑MM‑DD.md**, then proceed to production repos.

---

## 6) Portal build constraints (non‑negotiable)
- **Files:** ≤12 in `src/` (or 11 if Retool QR printing passes and staff page omitted).  
- **Dependencies:** exactly 6 prod deps (`@supabase/supabase-js`, `@supabase/auth-ui-react`, `react-router-dom`, `@tanstack/react-query`, `react`, `tailwindcss`).  
- **Routes:** only `/login`, `/dashboard`, `/schedule`, `/account`.  
- **LOC:** <500 total (excluding configs).  
- **No** custom auth, no extra libs, no admin panel (Retool), no mock data.

---

## 7) Stripe integration (Edge)
- **`stripe-webhook`**: verify signature, **check idempotency**, map to `premium299`, create Auth user (confirmed), upsert `customer_profile`, send magic link; finally insert `webhook_events` row.  
- **`create-checkout`**: receives CTA from Webflow, accepts `referral_code`/`promo_code` (optional), creates Session with `metadata`.  
- **`create-portal-session`**: exchanges current user → Stripe customer → short‑lived Customer Portal URL.

---

## 8) Deployment flow
1. **Supabase**: secrets for Stripe keys + webhook secret; deploy Edge functions.  
2. **Vercel**: deploy portal; set env vars (Supabase URL/anon key; Stripe publishable key; app URL).  
3. **Domain**: `portal.mystoragevalet.com` CNAME to Vercel.  
4. **Stripe Dashboard**: webhook → Edge URL; subscribe to `checkout.session.completed`, `customer.subscription.*`, `invoice.payment_*`.  
5. **Webflow**: CTA embed → call `create-checkout` endpoint; success redirect → portal domain.

---

## 9) Go/No‑Go gates (must be green)
- Magic links arrive within **≤120s** across 5 providers.  
- `/account` → Customer Portal opens via server‑generated session URL.  
- Checkout → webhook → profile upsert idempotent (no duplicates).  
- Dashboard shows items & stats; photos render via signed URLs; RLS verified.  
- Vercel SPA rewrites OK; deep links don’t 404.  
- Perf: 50 items render in <5s on mid‑tier devices.

---

## 10) Open configuration flags (to keep code stable while business evolves)
- `config_pricing.setup_fee_enabled` (default **false**) and `setup_fee_amount` (default **99**) — toggled in DB (no redeploy).  
- `config_schedule.minimum_notice_hours` (default 48).  
- `config_media.max_photo_size_mb` (default 5).  
- `config_referrals.enabled` and reward amounts (cents).

---

## 11) File manifest (target)
```
src/
├─ main.tsx
├─ App.tsx
├─ index.css
├─ vite-env.d.ts
├─ lib/
│  └─ supabase.ts
├─ components/
│  ├─ ProtectedRoute.tsx
│  ├─ ItemCard.tsx
│  └─ StaffPrintPage.tsx   # only if Retool fails
└─ pages/
   ├─ Login.tsx
   ├─ Dashboard.tsx
   ├─ Schedule.tsx
   └─ Account.tsx
```
**Total:** 12 (or 11 if staff page is removed).

---

## 12) Risks & mitigations (focused)
- **Email deliverability** → keep built‑in first; have SendGrid config ready post‑launch.  
- **Webhook reliability** → log‑first idempotency; Stripe retry‑safe design.  
- **Photo privacy/perf** → private bucket + signed URLs + size guardrails.  
- **Scope creep** → hard caps (files/deps/routes/LOC) + config tables for agility.  

---

## 13) What to exclude (holds from earlier doc)
- No multi‑tier pricing in code or env for production.  
- No customer‑facing cubic‑foot promises; gauges remain **UX**, not contractual.  
- No fifth route, seventh dependency, or new component libs.  
- No custom Node/Express backend; Supabase Edge only.

---

## 14) Immediate next actions
- ✅ Finalize Phase 0.6 functions & policies; produce validation report.  
- ✅ Create `sv-portal-final` and scaffold 4 routes within constraints.  
- ✅ Wire Stripe Checkout + Webhook + Portal Session.  
- ✅ Deploy (Supabase Edge + Vercel) and run Go/No‑Go tests.  

**This v3.1 document is the copy you should place in Claude/ChatGPT project libraries and the pre‑repo package.**
